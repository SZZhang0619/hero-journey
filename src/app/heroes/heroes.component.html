@if (heroesLoading()) {
  <app-loading-spinner label="Loading heroes..."></app-loading-spinner>
} @else if (heroesError(); as e) {
  <p class="error">Load failed: {{ e }}</p>
} @else {
  <section class="search" role="search">
    <label for="hero-search">Search heroes</label>
    <input
      id="hero-search"
      type="search"
      placeholder="輸入關鍵字 (至少 1 個字)"
      autocomplete="off"
      (input)="search($any($event.target).value)" />

    @if (searching()) {
      <app-loading-spinner label="Searching..."></app-loading-spinner>
    } @else if (searchKeyword()) {
      <p class="muted">搜尋「{{ searchKeyword() }}」</p>
    }

    @if (searchError(); as err) {
      <p class="error">Search failed: {{ err }}</p>
    }

    @if (searchKeyword() && !searching()) {
      <ul class="results">
        @for (hero of searchResults(); track hero.id) {
          <li>
            <button type="button" (click)="onSelect(hero)">
              {{ hero.name }}
              @if (hero.rank) { <span class="rank">[{{ hero.rank }}]</span> }
            </button>
            <a [routerLink]="['/detail', hero.id]" (click)="$event.stopPropagation()">View</a>
          </li>
        } @empty {
          <li class="muted">找不到符合「{{ searchKeyword() }}」的英雄。</li>
        }
      </ul>
    }
  </section>

  <section class="create" id="create">
    <app-hero-badge></app-hero-badge>
    <form (ngSubmit)="addHero()">
      <label for="new-hero">Name：</label>
      <input
        id="new-hero"
        name="new-hero"
        placeholder="enter new hero"
        required
        minlength="3"
        #newCtrl="ngModel"
        [ngModel]="newHeroName()"
        (ngModelChange)="newHeroName.set($event)" />
      <button type="submit" [disabled]="creating() || newCtrl.invalid">
        @if (creating()) { Saving... } @else { Add }
      </button>
    </form>
    @if (createError(); as err) {
      <p class="error">Create failed: {{ err }}</p>
    }
  </section>

  @if (feedback(); as msg) {
    <p class="feedback" aria-live="polite">{{ msg }}</p>
  }

  @if (deleteError(); as err) {
    <p class="error" aria-live="assertive">Delete failed: {{ err }}</p>
  }

  <section class="list">
    <ul>
      @for (h of heroes(); track h.id; let i = $index; let c = $count) {
        <li
          (click)="onSelect(h)"
          [class.is-a]="h.rank === 'A' || h.rank === 'S'"
          [class.selected]="selectedHero()?.id === h.id"
          [attr.data-id]="h.id"
          [attr.aria-current]="selectedHero()?.id === h.id ? 'true' : null">
          <span class="no">{{ i + 1 }}/{{ c }}</span>
          <span class="name">{{ h.name }}</span>
          @if (h.rank) { <span class="rank">[{{ h.rank }}]</span> }
          <span class="actions">
            <a [routerLink]="['/detail', h.id]" (click)="$event.stopPropagation()">View</a>
            <button
              type="button"
              class="danger"
              (click)="removeHero(h); $event.stopPropagation()"
              [disabled]="deletingId() === h.id">
              @if (deletingId() === h.id) { Deleting... } @else { Delete }
            </button>
          </span>
        </li>
      } @empty {
        <li class="empty-state" aria-live="polite">
          <h3>目前還沒有英雄</h3>
          <p>點擊上方的 Add 建立第一位夥伴，或在 in-memory API 填入假資料。</p>
        </li>
      }
    </ul>

    @if (selectedHero(); as s) {
      <aside class="panel">
        <h3>Edit</h3>
        <p>
          #{{ s.id }} - {{ s.name }}
          @if (s.rank) { <span class="rank">[{{ s.rank }}]</span> }
        </p>

        <label for="hero-name">Name：</label>
        <input
          id="hero-name"
          name="hero-name"
          type="text"
          required
          minlength="3"
          #nameCtrl="ngModel"
          [ngModel]="editName()"
          (ngModelChange)="editName.set($event)"
          [attr.aria-invalid]="nameCtrl.invalid && nameCtrl.touched" />

        <button
          type="button"
          (click)="saveSelected()"
          [disabled]="saving() || nameCtrl.invalid || editName().trim() === s.name">
          @if (saving()) { Saving... } @else { Save }
        </button>

        @if (saveError(); as err) {
          <p class="error">Save failed: {{ err }}</p>
        }
      </aside>
    }
  </section>
}
