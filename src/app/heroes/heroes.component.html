@if (heroesLoading()) {
  <app-loading-spinner label="Loading heroes..."></app-loading-spinner>
} @else if (heroesError(); as e) {
  <app-message-banner type="error">Load failed: {{ e }}</app-message-banner>
} @else {
  <section class="filters" aria-label="Filter heroes by rank">
    <span class="filters__label">分類：</span>
    <div class="filters__group">
      @for (option of rankOptions(); track option) {
        <button
          type="button"
          (click)="setRankFilter(option)"
          [class.active]="activeRank() === option">
          {{ rankLabel(option) }}
        </button>
      }
    </div>
  </section>

  <section class="search" role="search">
    <label for="hero-search">Search heroes</label>
    <input
      id="hero-search"
      type="search"
      placeholder="輸入關鍵字 (至少 2 個字)"
      autocomplete="off"
      (input)="search($any($event.target).value)" />

    @switch (searchState().status) {
      @case ('loading') { <app-loading-spinner label="Searching..."></app-loading-spinner> }
      @case ('error') { <app-message-banner type="error">{{ searchError() }}</app-message-banner> }
      @case ('success') { <app-message-banner type="info">{{ searchMessage() }}</app-message-banner> }
      @case ('idle') { @if (searchMessage()) { <app-message-banner type="info">{{ searchMessage() }}</app-message-banner> } }
    }

    @if (searchKeyword() && searchState().status !== 'loading') {
      <ul class="results">
        @for (hero of filteredSearchResults(); track hero.id) {
          <li>
            <app-hero-list-item
              [hero]="hero"
              [selectedId]="selectedId()"
              (pick)="onSelect($event)"></app-hero-list-item>
            <a [routerLink]="['/detail', hero.id]">View</a>
          </li>
        } @empty {
          <li class="muted">找不到符合「{{ searchKeyword() }}」的英雄。</li>
        }
      </ul>
    }
  </section>

  <section class="create" id="create">
    <form [formGroup]="createForm" (ngSubmit)="addHero()">
      <label for="new-hero">Name：</label>
      <input
        id="new-hero"
        placeholder="enter new hero"
        formControlName="name"
        type="text" />
      @if (controlError(createForm.controls.name); as err) {
        <small class="error">{{ err }}</small>
      } @else if (createForm.controls.name.pending) {
        <small class="hint">檢查名稱中...</small>
      }

      <label for="new-hero-rank">Rank：</label>
      <select id="new-hero-rank" formControlName="rank">
        <option [ngValue]="''">未指定</option>
        @for (rank of formRankOptions(); track rank) {
          <option [ngValue]="rank">{{ rankLabel(rank) }}</option>
        }
      </select>

      <button type="submit" [disabled]="creating() || createForm.invalid || createForm.pending">
        @if (creating()) { Saving... } @else { Add }
      </button>
    </form>

    @if (createError(); as err) {
      <app-message-banner type="error">Create failed: {{ err }}</app-message-banner>
    }
  </section>

  @if (feedback(); as msg) {
    <app-message-banner type="success">{{ msg }}</app-message-banner>
  }

  @if (deleteError(); as err) {
    <app-message-banner type="error">Delete failed: {{ err }}</app-message-banner>
  }

  <section class="list">
    <ul>
      @for (hero of filteredHeroes(); track hero.id; let index = $index; let count = $count) {
        <li
          [class.selected]="selectedId() === hero.id"
          [attr.data-id]="hero.id"
          [attr.aria-current]="selectedId() === hero.id ? 'true' : null">
          <span class="no">{{ index + 1 }}/{{ count }}</span>
          <app-hero-list-item
            [hero]="hero"
            [selectedId]="selectedId()"
            (pick)="onSelect($event)"></app-hero-list-item>
          <span class="actions">
            <a [routerLink]="['/detail', hero.id]">View</a>
            <button
              type="button"
              class="danger"
              (click)="removeHero(hero)"
              [disabled]="deletingId() === hero.id">
              @if (deletingId() === hero.id) { Deleting... } @else { Delete }
            </button>
          </span>
        </li>
      }

      @if (showEmpty()) {
        <li class="empty-state" aria-live="polite">
          <h3>目前還沒有英雄</h3>
          <p>點擊上方的 Add 建立第一位夥伴，或在 in-memory API 填入假資料。</p>
        </li>
      }
    </ul>

    @if (selectedHero(); as hero) {
      <aside class="panel" [formGroup]="editForm">
        <h3>Edit</h3>
        <p>
          #{{ hero.id }} - {{ hero.name }}
          @if (hero.rank) { <span class="rank">[{{ hero.rank }}]</span> }
        </p>

        <label for="hero-name">Name：</label>
        <input id="hero-name" type="text" formControlName="name" />
        @if (controlError(editForm.controls.name); as err) {
          <small class="error">{{ err }}</small>
        } @else if (editForm.controls.name.pending) {
          <small class="hint">檢查名稱中...</small>
        }

        <label for="hero-rank">Rank：</label>
        <select id="hero-rank" formControlName="rank">
          <option [ngValue]="''">未指定</option>
          @for (rank of formRankOptions(); track rank) {
            <option [ngValue]="rank">{{ rankLabel(rank) }}</option>
          }
        </select>

        <button
          type="button"
          (click)="saveSelected()"
          [disabled]="saving() || editForm.invalid || editForm.pending || !dirtyCompared()">
          @if (saving()) { Saving... } @else { Save }
        </button>

        @if (saveError(); as err) {
          <app-message-banner type="error">Save failed: {{ err }}</app-message-banner>
        }
      </aside>
    }
  </section>
}
